from psycopg2 import connect, extensions
from dotenv import load_dotenv
from os import getenv

def db_conn(db: str, password: str, user: str) -> extensions.connection:
    """Connects to the specified database.
    
    Args:
        db (str) - The name of the database to connect to.\n
        password (str) - The password for the user to connect with.\n
        user (str) - The user to connect with.\n
    
    Returns:
        psycopg2.extensions.connection: The connection object.
    """
    return connect(
        database = db,
        user = user,
        host = 'localhost',
        password = password,
        port = '5432'        
    )
    
def initialize_env():
    load_dotenv()
    
def initialize_db():
    DB_PASSWORD = getenv('DB_PASSWORD')
    conn = db_conn('postgres', DB_PASSWORD, 'postgres')
    cursor = conn.cursor()
    conn.autocommit = True

    cursor.execute(f"""SELECT 1 FROM pg_catalog.pg_database WHERE datname = 'code_samples';""")
    db_exists = cursor.fetchone()

    if db_exists:
        cursor.execute("DROP DATABASE code_samples;")
        cursor.execute("DROP OWNED BY codesamples_user CASCADE;")

    cursor.execute("CREATE DATABASE code_samples;")

    cursor.execute(f"""SELECT 1 FROM pg_roles WHERE rolname = 'codesamples_user';""")
    user_exists = cursor.fetchone()

    if not user_exists:
        cursor.execute("CREATE USER codesamples_user WITH PASSWORD 'codesamples';")

    cursor.execute("GRANT ALL PRIVILEGES ON DATABASE code_samples TO codesamples_user;")

    cursor.close()
    conn.close()

    conn = db_conn('code_samples', DB_PASSWORD, 'postgres')
    conn.autocommit = True
    cursor = conn.cursor()

    cursor.execute("ALTER SCHEMA public OWNER TO codesamples_user;")

    cursor.execute("GRANT ALL ON SCHEMA public TO codesamples_user;")
    cursor.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO codesamples_user;")

    cursor.close()
    conn.close()

    conn = db_conn('code_samples', 'codesamples', 'codesamples_user')
    cursor = conn.cursor()
    
    cursor.execute(f"""CREATE TABLE IF NOT EXISTS ecosystems (
        eco_name TEXT PRIMARY KEY
        );""")
    
    conn.commit()
    
    cursor.execute(f"""CREATE TABLE IF NOT EXISTS repositories (
        repo_name TEXT PRIMARY KEY,
        eco_name TEXT,
        org TEXT,
        html_url TEXT,
        stars INT,
        forks INT,
        watchers INT,
        contributors INT,
        language TEXT,
        size FLOAT,
        loc FLOAT,
        first_commit TIMESTAMP,
        last_commit TIMESTAMP,
        num_commits INT,
        evolution_years INT,
        evolution_months INT,
        evolution_days INT,
        age_years INT,
        age_months INT,
        age_days INT,
        year_since_last_update INT,
        month_since_last_update INT,
        day_since_last_update INT,
        open_issues INT,
        closed_issues INT,
        num_issues INT,
        open_prs INT,
        closed_prs INT,
        num_prs INT,
        merged_prs INT,
        percentage_merged_prs FLOAT,
        percentage_open_prs FLOAT,
        archived BOOLEAN,
        FOREIGN KEY (eco_name) REFERENCES ecosystems(eco_name)
        );""")
    
    conn.commit()

    cursor.execute(f"""CREATE TABLE IF NOT EXISTS commits (
        sha TEXT PRIMARY KEY,
        repo_name TEXT,
        eco_name TEXT,
        link TEXT,
        timestamp TIMESTAMP,
        message TEXT,
        FOREIGN KEY (repo_name) REFERENCES repositories(repo_name),
        FOREIGN KEY (eco_name) REFERENCES ecosystems(eco_name)
        );""")

    conn.commit()
    
    cursor.execute(f"""CREATE TABLE IF NOT EXISTS files (
        sha TEXT,
        name TEXT,
        type TEXT,
        PRIMARY KEY (sha, name),
        FOREIGN KEY (sha) REFERENCES commits(sha)
    );""")
    
    conn.commit()

    cursor.execute(f"""CREATE TABLE IF NOT EXISTS hunks (
        id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        file_name TEXT,
        sha TEXT,
        header TEXT,
        lines TEXT[],
        FOREIGN KEY (sha, file_name) REFERENCES files(sha, name)
    );""")

    conn.commit()

    cursor.close()
    conn.close()
    
def general_add(table: str, values: dict):
    """Adds a row to the specified table.
    
    Args:
        table (str) - The name of the table to add the row to.\n
        values (dict) - The values to insert into the table.
    """
    conn = db_conn('code_samples', 'codesamples', 'codesamples_user')
    cursor = conn.cursor()
    
    columns = ', '.join(values.keys())
    placeholders = ', '.join([f'%({key})s' for key in values.keys()])
    
    cursor.execute(f"""INSERT INTO {table} ({columns}) VALUES ({placeholders});""", values)
    
    conn.commit()
    cursor.close()
    conn.close()
    
def general_exists(table: str, values: dict) -> bool:
    """Checks if a row exists in the specified table.
    
    Args:
        table (str) - The name of the table to check.\n
        values (dict) - The values to check for in the table.
        
    Returns:
        bool: True if the row exists in the table, False otherwise.
    """
    conn = db_conn('code_samples', 'codesamples', 'codesamples_user')
    cursor = conn.cursor()
    
    columns = ' AND '.join([f'{key} = %({key})s' for key in values.keys()])
    
    cursor.execute(f"""SELECT 1 FROM {table} WHERE {columns};""", values)
    exists = cursor.fetchone()
    
    cursor.close()
    conn.close()
    
    return exists